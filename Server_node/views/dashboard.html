require('dotenv').config();

const express = require('express');
const http = require('http');
const { Server } = require("socket.io");
const bodyParser = require('body-parser');
const cors = require('cors');
const session = require('express-session');
const path = require('path');
const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');

// --- TÆNZÄ°MLÆMÆLÆR ---
const ADMIN_USER = process.env.ADMIN_USER || "admin";
const ADMIN_PASS = process.env.ADMIN_PASS || "admin123";
const TELEGRAM_TOKEN = process.env.TELEGRAM_BOT_TOKEN; // .env-dÉ™n oxuyur

const app = express();
const server = http.createServer(app);
const io = new Server(server, { cors: { origin: "*" } });

app.set('trust proxy', 1); // Nginx Ã¼Ã§Ã¼n
app.use(cors());
app.use(bodyParser.json({ limit: '50mb' }));
app.use(bodyParser.urlencoded({ limit: '50mb', extended: true }));

app.use(session({
    secret: process.env.SESSION_SECRET || 'gizli_aÃ§ar_rj_pos_secure',
    resave: false,
    saveUninitialized: true,
    cookie: { secure: false, maxAge: 24 * 60 * 60 * 1000 } // 24 saat
}));

// --- YADDAÅ (DATABASE ÆVÆZÄ°) ---
const DATA_FILE = 'server_data.json';
let localData = {
    partners: {}, // { partner_id: chat_id }
    last_processed_order: null // Son iÅŸlÉ™nÉ™n sifariÅŸ
};

// YaddaÅŸÄ± yÃ¼klÉ™
if (fs.existsSync(DATA_FILE)) {
    try {
        localData = JSON.parse(fs.readFileSync(DATA_FILE));
        if (!localData.partners) localData.partners = {};
    } catch (e) { console.error("Data oxuma xÉ™tasÄ±:", e); }
}

function saveData() {
    fs.writeFileSync(DATA_FILE, JSON.stringify(localData, null, 2));
}

// --- TELEGRAM BOT ---
let bot = null;
if (TELEGRAM_TOKEN) {
    bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });
    console.log("ğŸ¤– Telegram Bot Aktivdir");

    // /start É™mri
    bot.onText(/\/start/, (msg) => {
        const chatId = msg.chat.id;
        const name = msg.from.first_name;
        bot.sendMessage(chatId, `Salam, ${name}! ğŸ‘‹\nSizin Telegram ID: \`${chatId}\`\n\nBu kodu AdminÉ™ tÉ™qdim edin ki, hesabÄ±nÄ±zla É™laqÉ™lÉ™ndirilsin.`, { parse_mode: 'Markdown' });
    });

    // Hesabat dÃ¼ymÉ™lÉ™ri (GÉ™lÉ™cÉ™kdÉ™ geniÅŸlÉ™ndirilÉ™ bilÉ™r)
    bot.on('message', (msg) => {
        if (msg.text === '/report') {
            bot.sendMessage(msg.chat.id, "ğŸ“Š Hesabat sisteminiz aktivdir. SatÄ±ÅŸ olduqda bildiriÅŸ alacaqsÄ±nÄ±z.");
        }
    });
} else {
    console.log("âš ï¸ XÉ™bÉ™rdarlÄ±q: TELEGRAM_BOT_TOKEN tapÄ±lmadÄ± (.env)");
}

// --- ROUTES ---

// 1. GiriÅŸ
app.get('/', (req, res) => {
    if (req.session.authenticated) {
        // ÆgÉ™r giriÅŸ edilibsÉ™, dashboard faylÄ±nÄ± gÃ¶ndÉ™r
        return res.sendFile(path.join(__dirname, 'views', 'dashboard.html'));
    }
    // GiriÅŸ edilmÉ™yibsÉ™, login faylÄ±nÄ± gÃ¶ndÉ™r
    res.sendFile(path.join(__dirname, 'views', 'login.html'));
});

// 2. Login Post
app.post('/login', (req, res) => {
    const { username, password } = req.body;
    if (username === ADMIN_USER && password === ADMIN_PASS) {
        req.session.authenticated = true;
        res.redirect('/');
    } else {
        res.redirect('/?error=1');
    }
});

// 3. Ã‡Ä±xÄ±ÅŸ
app.get('/logout', (req, res) => {
    req.session.destroy();
    res.redirect('/');
});

// 4. API (MaÄŸazadan MÉ™lumat QÉ™bulu)
app.post('/api/report', (req, res) => {
    try {
        const data = req.body;
        const payload = data.payload;

        // A. PartnyorlarÄ± yoxlayÄ±b birlÉ™ÅŸdiririk
        if (payload.partners && Array.isArray(payload.partners)) {
            payload.partners = payload.partners.map(p => {
                if (localData.partners[p.id]) {
                    p.telegram_chat_id = localData.partners[p.id];
                }
                return p;
            });
        }

        // B. SatÄ±ÅŸ BildiriÅŸi (Telegram)
        if (payload.latest_orders && payload.latest_orders.length > 0 && bot) {
            const lastOrder = payload.latest_orders[0]; // Æn son satÄ±ÅŸ
            
            if (lastOrder.receipt_code !== localData.last_processed_order) {
                localData.last_processed_order = lastOrder.receipt_code;
                saveData(); // Son satÄ±ÅŸÄ± yadda saxla

                // Burada gÉ™lÉ™cÉ™kdÉ™ promokod sahibinÉ™ mesaj gÃ¶ndÉ™rmÉ™ mÉ™ntiqi qurulacaq
            }
        }

        // C. CanlÄ± Ekrana Ã¶tÃ¼r
        io.emit('live_update', { 
            type: 'full_report', 
            payload: payload, 
            time: new Date().toLocaleTimeString() 
        });
        
        res.json({ status: true });

    } catch (e) {
        console.error(e);
        res.status(500).json({ status: false, error: e.message });
    }
});

// Socket.IO - Admin PaneldÉ™n gÉ™lÉ™n É™mrlÉ™r
io.on('connection', (socket) => {
    
    // Admin Telegram ID tÉ™yin edÉ™ndÉ™
    socket.on('update_partner_telegram', (data) => {
        if (data.id && data.telegram_chat_id) {
            localData.partners[data.id] = data.telegram_chat_id;
            saveData();
            
            // Bot vasitÉ™silÉ™ partnyora xÉ™bÉ™r veririk
            if (bot) {
                bot.sendMessage(data.telegram_chat_id, "âœ… Sizin hesabÄ±nÄ±z tÉ™sdiqlÉ™ndi! ArtÄ±q satÄ±ÅŸ bildiriÅŸlÉ™rini buradan alacaqsÄ±nÄ±z.")
                   .catch(e => console.error("Telegram gÃ¶ndÉ™rmÉ™ xÉ™tasÄ±:", e.message));
            }
        }
    });

    socket.on('request_last_data', () => {
        // Yeni qoÅŸulana mÃ¶vcud datanÄ± gÃ¶ndÉ™rmÉ™k olar (É™gÉ™r yaddaÅŸda saxlasaq)
    });
});

const PORT = 3000;
server.listen(PORT, () => {
    console.log(`ğŸš€ Server Ä°ÅŸlÉ™yir: Port ${PORT}`);
});