<?php

namespace App\Services;

use App\Models\Order;
use App\Models\Product;
use App\Models\ProductBatch;
use App\Models\Setting;
use App\Models\Partner; // Partnyor modeli varsa
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class SyncService
{
    protected $serverUrl;

    public function __construct()
    {
        // Node.js serverinin ünvanı (.env faylından və ya settings-dən)
        // Məsələn: http://vmi3036725.contaboserver.net:3000
        $this->serverUrl = Setting::where('key', 'server_url')->value('value');
        if ($this->serverUrl) {
            $this->serverUrl = rtrim($this->serverUrl, '/');
        }
    }

    /**
     * Bütün Hesabatları Hesablayır və Node.js-ə Göndərir
     */
    public function pushData()
    {
        if (!$this->serverUrl) return ['status' => false, 'message' => 'Server URL yoxdur'];

        // 1. GÜNLÜK SATIŞ HESABATI
        $today = Carbon::today();
        $todayStats = Order::whereDate('created_at', $today)
            ->select(
                DB::raw('sum(grand_total) as total_sales'),
                DB::raw('count(*) as count_sales'),
                DB::raw('sum(grand_total - total_cost - total_tax) as net_profit') // Təxmini mənfəət
            )->first();

        // 2. STOK VƏ ANBAR DƏYƏRİ (Sizin ReportController-dəki məntiq)
        // Yaddaş dolmasın deyə sadə sorğu ilə hesablayırıq
        $stockStats = DB::table('product_batches')
            ->where('current_quantity', '>', 0)
            ->select(
                DB::raw('SUM(current_quantity * cost_price) as total_cost_value'), // Maya dəyəri
                DB::raw('COUNT(*) as batch_count')
            )->first();
        
        // Satış dəyərini tapmaq üçün Product ilə join etmək lazımdır
        $totalSaleValue = DB::table('product_batches')
            ->join('products', 'product_batches.product_id', '=', 'products.id')
            ->where('product_batches.current_quantity', '>', 0)
            ->sum(DB::raw('product_batches.current_quantity * products.selling_price'));

        // 3. PARTNYOR STATİSTİKASI (Əgər Partner modeli varsa)
        $partnerCount = 0;
        if (class_exists(Partner::class)) {
            $partnerCount = Partner::count();
        }

        // 4. KRİTİK STOK SAYI (ReportController-dən)
        $criticalStockCount = Product::whereRaw('alert_limit > (select coalesce(sum(current_quantity), 0) from product_batches where product_batches.product_id = products.id)')->count();

        // 5. SON SATIŞLAR (Canlı axın üçün)
        $latestOrders = Order::latest()->take(5)->get()->map(function($order) {
            return [
                'receipt_code' => $order->receipt_code,
                'grand_total' => $order->grand_total,
                'payment_method' => $order->payment_method,
                'time' => $order->created_at->format('H:i:s'),
                'items_count' => $order->items->count()
            ];
        });

        // PAKETİ HAZIRLAYIRIQ
        $payload = [
            'today_sales' => $todayStats->total_sales ?? 0,
            'today_count' => $todayStats->count_sales ?? 0,
            'today_profit' => $todayStats->net_profit ?? 0,
            'warehouse_cost' => $stockStats->total_cost_value ?? 0,
            'warehouse_sale' => $totalSaleValue ?? 0,
            'potential_profit' => $totalSaleValue - ($stockStats->total_cost_value ?? 0),
            'critical_stock' => $criticalStockCount,
            'partner_count' => $partnerCount,
            'latest_orders' => $latestOrders
        ];

        // GÖNDƏRİRİK
        try {
            Http::timeout(5)->post($this->serverUrl . '/api/report', [
                'type' => 'full_report', // Yeni tip təyin edirik
                'payload' => $payload
            ]);
            
            return ['status' => true, 'message' => 'Hesabatlar Node.js-ə göndərildi'];

        } catch (\Exception $e) {
            return ['status' => false, 'message' => 'Node.js Xətası: ' . $e->getMessage()];
        }
    }

    public function pullData()
    {
        return ['status' => true, 'message' => 'Monitorinq rejimi aktivdir.'];
    }
}